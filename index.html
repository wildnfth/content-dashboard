<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Performance Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --surface2: #1a1a24;
      --border: #2a2a3a;
      --accent: #c8f04a;
      --accent2: #4af0c8;
      --accent3: #f04ac8;
      --text: #e8e8f0;
      --text-dim: #7a7a9a;
      --tiktok: #ff2d55;
      --instagram: #e1306c;
      --youtube: #ff0000;
      --radius: 10px;
      --mono: 'DM Mono', monospace;
      --display: 'Syne', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--mono);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* === AUTH SCREEN === */
    #auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      position: relative;
    }

    #auth-screen::before {
      content: '';
      position: fixed;
      top: -200px; left: -200px;
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(200,240,74,0.08) 0%, transparent 70%);
      pointer-events: none;
    }

    .auth-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 48px 40px;
      width: 100%;
      max-width: 400px;
      margin: 20px;
    }

    .auth-logo {
      font-family: var(--display);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .auth-title {
      font-family: var(--display);
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 32px;
      line-height: 1.2;
    }

    .form-group { margin-bottom: 20px; }

    .form-label {
      display: block;
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 14px;
      transition: border-color 0.2s;
      outline: none;
    }

    .form-input:focus { border-color: var(--accent); }

    .btn-primary {
      width: 100%;
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      border-radius: var(--radius);
      padding: 14px;
      font-family: var(--display);
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      margin-top: 8px;
    }

    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .auth-error {
      background: rgba(240,74,200,0.1);
      border: 1px solid rgba(240,74,200,0.3);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 13px;
      color: var(--accent3);
      margin-top: 16px;
      display: none;
    }

    /* === MAIN DASHBOARD === */
    #dashboard { display: none; }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10,10,15,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
    }

    .topbar-brand {
      font-family: var(--display);
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-logout {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 7px 14px;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-logout:hover {
      border-color: var(--accent3);
      color: var(--accent3);
    }

    .main-content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* === STATS SUMMARY === */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (max-width: 600px) {
      .stats-row { grid-template-columns: 1fr; }
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
    }

    .stat-platform {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .stat-value {
      font-family: var(--display);
      font-size: 24px;
      font-weight: 800;
    }

    .stat-card.tiktok .stat-value { color: var(--tiktok); }
    .stat-card.instagram .stat-value { color: var(--instagram); }
    .stat-card.youtube .stat-value { color: var(--youtube); }

    /* === TOOLBAR === */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .toolbar-title {
      font-family: var(--display);
      font-size: 18px;
      font-weight: 700;
    }

    .btn-add {
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-family: var(--display);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: opacity 0.2s;
    }

    .btn-add:hover { opacity: 0.85; }

    /* === TABLE === */
    .table-wrapper {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    thead {
      background: var(--surface2);
    }

    th {
      padding: 14px 16px;
      text-align: left;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      font-weight: 500;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(42,42,58,0.5);
      font-size: 13px;
      vertical-align: middle;
    }

    tr:last-child td { border-bottom: none; }

    tr:hover td { background: rgba(255,255,255,0.02); }

    /* === VIDEO CODE BUTTON === */
    .code-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      color: var(--accent2);
      font-family: var(--mono);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .code-btn:hover {
      border-color: var(--accent2);
      background: rgba(74,240,200,0.08);
    }

    /* === VIEWS BADGE === */
    .views-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .view-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .view-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .view-dot.tiktok { background: var(--tiktok); }
    .view-dot.instagram { background: var(--instagram); }
    .view-dot.youtube { background: var(--youtube); }

    /* === ACTION BUTTONS === */
    .action-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover { border-color: var(--accent); color: var(--accent); }
    .action-btn.del:hover { border-color: var(--accent3); color: var(--accent3); }

    .action-cell { display: flex; gap: 6px; }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state .icon { font-size: 32px; margin-bottom: 12px; }
    .empty-state p { font-size: 13px; }

    /* === MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      padding: 24px 24px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-family: var(--display);
      font-size: 20px;
      font-weight: 800;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .modal-body { padding: 24px; }

    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 480px) {
      .modal-grid { grid-template-columns: 1fr; }
    }

    .modal-grid .full { grid-column: 1 / -1; }

    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn-cancel {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 20px;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel:hover { border-color: var(--text-dim); color: var(--text); }

    .btn-save {
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      border-radius: var(--radius);
      padding: 12px 24px;
      font-family: var(--display);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-save:hover { opacity: 0.85; }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

    /* === TIME PICKER MODAL === */
    .time-picker-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 320px;
      padding: 24px;
    }

    .time-picker-title {
      font-family: var(--display);
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }

    .time-display {
      font-family: var(--display);
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      color: var(--accent);
      margin-bottom: 24px;
      letter-spacing: 0.05em;
    }

    .time-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .time-col label {
      display: block;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      text-align: center;
      margin-bottom: 8px;
    }

    .time-spin {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .spin-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 40px; height: 36px;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spin-btn:hover { border-color: var(--accent); color: var(--accent); }

    .spin-value {
      font-family: var(--display);
      font-size: 28px;
      font-weight: 700;
      min-width: 50px;
      text-align: center;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      color: var(--text);
    }

    /* === LINKS POPUP === */
    .links-popup {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 340px;
      padding: 24px;
    }

    .links-popup-title {
      font-family: var(--display);
      font-size: 14px;
      font-weight: 700;
      color: var(--text-dim);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 10px;
    }

    .links-popup-code {
      font-family: var(--display);
      font-size: 20px;
      font-weight: 800;
      color: var(--accent2);
      margin-bottom: 20px;
    }

    .link-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s;
      font-size: 13px;
    }

    .link-item:last-child { margin-bottom: 0; }
    .link-item:hover { border-color: var(--border); transform: translateX(4px); }
    .link-item.tiktok:hover { border-color: var(--tiktok); background: rgba(255,45,85,0.08); }
    .link-item.instagram:hover { border-color: var(--instagram); background: rgba(225,48,108,0.08); }
    .link-item.youtube:hover { border-color: var(--youtube); background: rgba(255,0,0,0.08); }

    .link-icon { font-size: 20px; flex-shrink: 0; }

    .link-info { flex: 1; }
    .link-platform { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); }
    .link-url { font-size: 12px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

    .link-arrow { color: var(--text-dim); font-size: 14px; }

    .no-link {
      opacity: 0.4;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* === LOADING === */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
      font-size: 13px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 20px;
      font-size: 13px;
      z-index: 999;
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { border-color: var(--accent); color: var(--accent); }
    .toast.error { border-color: var(--accent3); color: var(--accent3); }

    /* Input no-spinner for number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Content Studio</div>
    <div class="auth-title">Performance<br/>Dashboard</div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="auth-email" class="form-input" placeholder="email@anda.com" />
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="auth-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button class="btn-primary" id="btn-login">Masuk</button>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-brand">Dashboard</div>
    <div class="topbar-right">
      <span id="user-email" style="font-size:12px;color:var(--text-dim)"></span>
      <button class="btn-logout" id="btn-logout">Keluar</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card tiktok">
        <div class="stat-platform">TikTok ‚Äî Total Views</div>
        <div class="stat-value" id="stat-tiktok">0</div>
      </div>
      <div class="stat-card instagram">
        <div class="stat-platform">Instagram ‚Äî Total Views</div>
        <div class="stat-value" id="stat-instagram">0</div>
      </div>
      <div class="stat-card youtube">
        <div class="stat-platform">YouTube ‚Äî Total Views</div>
        <div class="stat-value" id="stat-youtube">0</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-title">Daftar Post</div>
      <button class="btn-add" id="btn-add-post">
        <span>Ôºã</span> Tambah Post
      </button>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>Tanggal</th>
            <th>Jam Upload</th>
            <th>Kode Video</th>
            <th>Views</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="posts-tbody">
          <tr><td colspan="6"><div class="loading">Memuat data...</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL: ADD/EDIT POST -->
<div class="modal-overlay" id="post-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Tambah Post</div>
      <button class="modal-close" id="modal-close-btn">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div>
          <label class="form-label">Tanggal</label>
          <input type="date" id="input-tanggal" class="form-input" />
        </div>
        <div>
          <label class="form-label">Nomor</label>
          <input type="number" id="input-nomor" class="form-input" placeholder="1" min="1" />
        </div>
        <div>
          <label class="form-label">Jam Upload</label>
          <input type="text" id="input-jam" class="form-input" placeholder="Klik untuk pilih jam" readonly style="cursor:pointer" id="input-jam" />
        </div>
        <div>
          <label class="form-label">Kode Video</label>
          <input type="text" id="input-kode" class="form-input" placeholder="VID-001" />
        </div>
        <div class="full">
          <label class="form-label">Link TikTok</label>
          <input type="url" id="input-link-tiktok" class="form-input" placeholder="https://tiktok.com/@..." />
        </div>
        <div class="full">
          <label class="form-label">Link Instagram</label>
          <input type="url" id="input-link-instagram" class="form-input" placeholder="https://instagram.com/p/..." />
        </div>
        <div class="full">
          <label class="form-label">Link YouTube</label>
          <input type="url" id="input-link-youtube" class="form-input" placeholder="https://youtube.com/watch?v=..." />
        </div>
        <div>
          <label class="form-label">Views TikTok</label>
          <input type="number" id="input-views-tiktok" class="form-input" placeholder="0" min="0" />
        </div>
        <div>
          <label class="form-label">Views Instagram</label>
          <input type="number" id="input-views-instagram" class="form-input" placeholder="0" min="0" />
        </div>
        <div class="full">
          <label class="form-label">Views YouTube</label>
          <input type="number" id="input-views-youtube" class="form-input" placeholder="0" min="0" />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="modal-cancel-btn">Batal</button>
      <button class="btn-save" id="modal-save-btn">Simpan</button>
    </div>
  </div>
</div>

<!-- MODAL: TIME PICKER -->
<div class="modal-overlay" id="time-modal">
  <div class="time-picker-modal">
    <div class="time-picker-title">Pilih Jam Upload</div>
    <div class="time-display" id="time-display">00:00</div>
    <div class="time-controls">
      <div class="time-col">
        <label>Jam</label>
        <div class="time-spin">
          <button class="spin-btn" id="hour-up">‚ñ≤</button>
          <div class="spin-value" id="hour-val">00</div>
          <button class="spin-btn" id="hour-down">‚ñº</button>
        </div>
      </div>
      <div class="time-col">
        <label>Menit</label>
        <div class="time-spin">
          <button class="spin-btn" id="min-up">‚ñ≤</button>
          <div class="spin-value" id="min-val">00</div>
          <button class="spin-btn" id="min-down">‚ñº</button>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;">
      <button class="btn-cancel" style="flex:1" id="time-cancel">Batal</button>
      <button class="btn-save" style="flex:1" id="time-confirm">Pilih</button>
    </div>
  </div>
</div>

<!-- MODAL: LINKS POPUP -->
<div class="modal-overlay" id="links-modal">
  <div class="links-popup">
    <div class="links-popup-title">Kode Video</div>
    <div class="links-popup-code" id="links-code"></div>
    <a class="link-item tiktok" id="link-tiktok" href="#" target="_blank" rel="noopener">
      <span class="link-icon">üéµ</span>
      <div class="link-info">
        <div class="link-platform">TikTok</div>
        <div class="link-url" id="link-tiktok-url">‚Äî</div>
      </div>
      <span class="link-arrow">‚Üí</span>
    </a>
    <a class="link-item instagram" id="link-instagram" href="#" target="_blank" rel="noopener">
      <span class="link-icon">üì∏</span>
      <div class="link-info">
        <div class="link-platform">Instagram</div>
        <div class="link-url" id="link-instagram-url">‚Äî</div>
      </div>
      <span class="link-arrow">‚Üí</span>
    </a>
    <a class="link-item youtube" id="link-youtube" href="#" target="_blank" rel="noopener">
      <span class="link-icon">‚ñ∂Ô∏è</span>
      <div class="link-info">
        <div class="link-platform">YouTube</div>
        <div class="link-url" id="link-youtube-url">‚Äî</div>
      </div>
      <span class="link-arrow">‚Üí</span>
    </a>
    <button class="btn-cancel" style="width:100%;margin-top:16px" id="links-close">Tutup</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================================
// CONFIG ‚Äî GANTI DENGAN MILIK MASTER
// ============================================================
const SUPABASE_URL = 'GANTI_DENGAN_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'GANTI_DENGAN_SUPABASE_ANON_KEY';
// ============================================================

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---- STATE ----
let editingId = null;
let pickerHour = 0;
let pickerMin = 0;

// ---- UTILS ----
function fmt2(n) { return String(n).padStart(2, '0'); }

function fmtViews(n) {
  if (!n && n !== 0) return '‚Äî';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toLocaleString('id-ID');
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 2500);
}

// ---- AUTH ----
document.getElementById('btn-login').addEventListener('click', async () => {
  const email = document.getElementById('auth-email').value.trim();
  const pass = document.getElementById('auth-password').value;
  const btn = document.getElementById('btn-login');
  const err = document.getElementById('auth-error');
  err.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Memuat...';
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  btn.disabled = false;
  btn.textContent = 'Masuk';
  if (error) {
    err.textContent = 'Email atau password salah.';
    err.style.display = 'block';
  }
});

document.getElementById('auth-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('btn-login').click();
});

document.getElementById('btn-logout').addEventListener('click', async () => {
  await sb.auth.signOut();
});

sb.auth.onAuthStateChange((event, session) => {
  if (session) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('user-email').textContent = session.user.email;
    loadPosts();
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
  }
});

// ---- LOAD POSTS ----
async function loadPosts() {
  const { data, error } = await sb.from('posts').select('*').order('tanggal', { ascending: false }).order('nomor', { ascending: true });
  if (error) { showToast('Gagal memuat data', 'error'); return; }
  renderTable(data || []);
  renderStats(data || []);
}

function renderStats(data) {
  const ttk = data.reduce((s, r) => s + (parseInt(r.views_tiktok) || 0), 0);
  const ig = data.reduce((s, r) => s + (parseInt(r.views_instagram) || 0), 0);
  const yt = data.reduce((s, r) => s + (parseInt(r.views_youtube) || 0), 0);
  document.getElementById('stat-tiktok').textContent = fmtViews(ttk);
  document.getElementById('stat-instagram').textContent = fmtViews(ig);
  document.getElementById('stat-youtube').textContent = fmtViews(yt);
}

function renderTable(data) {
  const tbody = document.getElementById('posts-tbody');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="icon">üì≠</div><p>Belum ada data post.<br/>Klik "+ Tambah Post" untuk mulai.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(row => `
    <tr>
      <td><span style="color:var(--text-dim)">#${row.nomor || '‚Äî'}</span></td>
      <td>${fmtDate(row.tanggal)}</td>
      <td><span style="color:var(--accent)">${row.jam_upload || '‚Äî'}</span></td>
      <td>
        <button class="code-btn" onclick="openLinks(${JSON.stringify(row).replace(/"/g,'&quot;')})">
          ${row.kode_video || '‚Äî'}
        </button>
      </td>
      <td>
        <div class="views-cell">
          <div class="view-item"><span class="view-dot tiktok"></span>${fmtViews(row.views_tiktok)}</div>
          <div class="view-item"><span class="view-dot instagram"></span>${fmtViews(row.views_instagram)}</div>
          <div class="view-item"><span class="view-dot youtube"></span>${fmtViews(row.views_youtube)}</div>
        </div>
      </td>
      <td>
        <div class="action-cell">
          <button class="action-btn" onclick="openEdit(${JSON.stringify(row).replace(/"/g,'&quot;')})">Edit</button>
          <button class="action-btn del" onclick="deletePost('${row.id}')">Hapus</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ---- LINKS POPUP ----
function openLinks(row) {
  document.getElementById('links-code').textContent = row.kode_video || '‚Äî';

  const setLink = (elId, urlId, url, cssClass) => {
    const el = document.getElementById(elId);
    const urlEl = document.getElementById(urlId);
    if (url) {
      el.href = url;
      urlEl.textContent = url.replace('https://','').substring(0, 35) + (url.length > 38 ? '‚Ä¶' : '');
      el.classList.remove('no-link');
    } else {
      el.href = '#';
      urlEl.textContent = 'Tidak ada link';
      el.classList.add('no-link');
    }
  };

  setLink('link-tiktok', 'link-tiktok-url', row.link_tiktok, 'tiktok');
  setLink('link-instagram', 'link-instagram-url', row.link_instagram, 'instagram');
  setLink('link-youtube', 'link-youtube-url', row.link_youtube, 'youtube');

  document.getElementById('links-modal').classList.add('open');
}

document.getElementById('links-close').addEventListener('click', () => {
  document.getElementById('links-modal').classList.remove('open');
});

document.getElementById('links-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('links-modal'))
    document.getElementById('links-modal').classList.remove('open');
});

// ---- TIME PICKER ----
function updateTimePicker() {
  document.getElementById('hour-val').textContent = fmt2(pickerHour);
  document.getElementById('min-val').textContent = fmt2(pickerMin);
  document.getElementById('time-display').textContent = `${fmt2(pickerHour)}:${fmt2(pickerMin)}`;
}

document.getElementById('hour-up').addEventListener('click', () => { pickerHour = (pickerHour + 1) % 24; updateTimePicker(); });
document.getElementById('hour-down').addEventListener('click', () => { pickerHour = (pickerHour - 1 + 24) % 24; updateTimePicker(); });
document.getElementById('min-up').addEventListener('click', () => { pickerMin = (pickerMin + 1) % 60; updateTimePicker(); });
document.getElementById('min-down').addEventListener('click', () => { pickerMin = (pickerMin - 1 + 60) % 60; updateTimePicker(); });

document.getElementById('input-jam').addEventListener('click', () => {
  const cur = document.getElementById('input-jam').value;
  if (cur) { const [h, m] = cur.split(':'); pickerHour = parseInt(h); pickerMin = parseInt(m); }
  updateTimePicker();
  document.getElementById('time-modal').classList.add('open');
});

document.getElementById('time-confirm').addEventListener('click', () => {
  document.getElementById('input-jam').value = `${fmt2(pickerHour)}:${fmt2(pickerMin)}`;
  document.getElementById('time-modal').classList.remove('open');
});

document.getElementById('time-cancel').addEventListener('click', () => {
  document.getElementById('time-modal').classList.remove('open');
});

// ---- POST MODAL ----
function clearModal() {
  ['input-tanggal','input-nomor','input-jam','input-kode',
   'input-link-tiktok','input-link-instagram','input-link-youtube',
   'input-views-tiktok','input-views-instagram','input-views-youtube']
    .forEach(id => document.getElementById(id).value = '');
}

document.getElementById('btn-add-post').addEventListener('click', () => {
  editingId = null;
  clearModal();
  // default tanggal hari ini
  document.getElementById('input-tanggal').value = new Date().toISOString().split('T')[0];
  document.getElementById('modal-title').textContent = 'Tambah Post';
  document.getElementById('post-modal').classList.add('open');
});

function openEdit(row) {
  editingId = row.id;
  document.getElementById('modal-title').textContent = 'Edit Post';
  document.getElementById('input-tanggal').value = row.tanggal || '';
  document.getElementById('input-nomor').value = row.nomor || '';
  document.getElementById('input-jam').value = row.jam_upload || '';
  document.getElementById('input-kode').value = row.kode_video || '';
  document.getElementById('input-link-tiktok').value = row.link_tiktok || '';
  document.getElementById('input-link-instagram').value = row.link_instagram || '';
  document.getElementById('input-link-youtube').value = row.link_youtube || '';
  document.getElementById('input-views-tiktok').value = row.views_tiktok ?? '';
  document.getElementById('input-views-instagram').value = row.views_instagram ?? '';
  document.getElementById('input-views-youtube').value = row.views_youtube ?? '';
  document.getElementById('post-modal').classList.add('open');
}

function closePostModal() {
  document.getElementById('post-modal').classList.remove('open');
  editingId = null;
}

document.getElementById('modal-close-btn').addEventListener('click', closePostModal);
document.getElementById('modal-cancel-btn').addEventListener('click', closePostModal);
document.getElementById('post-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('post-modal')) closePostModal();
});

document.getElementById('modal-save-btn').addEventListener('click', async () => {
  const payload = {
    tanggal: document.getElementById('input-tanggal').value || null,
    nomor: parseInt(document.getElementById('input-nomor').value) || null,
    jam_upload: document.getElementById('input-jam').value || null,
    kode_video: document.getElementById('input-kode').value.trim() || null,
    link_tiktok: document.getElementById('input-link-tiktok').value.trim() || null,
    link_instagram: document.getElementById('input-link-instagram').value.trim() || null,
    link_youtube: document.getElementById('input-link-youtube').value.trim() || null,
    views_tiktok: parseInt(document.getElementById('input-views-tiktok').value) || 0,
    views_instagram: parseInt(document.getElementById('input-views-instagram').value) || 0,
    views_youtube: parseInt(document.getElementById('input-views-youtube').value) || 0,
  };

  const btn = document.getElementById('modal-save-btn');
  btn.disabled = true; btn.textContent = 'Menyimpan...';

  let error;
  if (editingId) {
    ({ error } = await sb.from('posts').update(payload).eq('id', editingId));
  } else {
    ({ error } = await sb.from('posts').insert(payload));
  }

  btn.disabled = false; btn.textContent = 'Simpan';

  if (error) { showToast('Gagal menyimpan: ' + error.message, 'error'); return; }
  showToast(editingId ? 'Post berhasil diperbarui!' : 'Post berhasil ditambahkan!');
  closePostModal();
  loadPosts();
});

// ---- DELETE ----
async function deletePost(id) {
  if (!confirm('Hapus post ini? Tindakan tidak bisa dibatalkan.')) return;
  const { error } = await sb.from('posts').delete().eq('id', id);
  if (error) { showToast('Gagal menghapus', 'error'); return; }
  showToast('Post dihapus.');
  loadPosts();
}
</script>
</body>
</html>
